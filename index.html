<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Michael Henretty - Code</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/sky.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/vs2015.css">
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Lato:wght@700;900&display=swap');
			:root .reveal .slides {
				--r-main-font: 'Lato', sans-serif;
				--r-heading-font: 'Lato', sans-serif;
				font-family: 'Lato', sans-serif;
			}

			:root .reveal .progress {
				height: 10px;
			}

			:root .reveal .slide-number {
				font-size: 18px;
				bottom: 19px;
				padding: 5px 10px;
			}

			.mytitle {
				font-size: 200%;
				font-weight: bold;
			}

			.heading {
				font-size: 160%;
				font-weight: bold;
				margin-bottom: 40px;
				text-align: left;
			}

			.normal {
				text-align: left;
				margin: 0 30px;
			}

			.small {
				font-size: 50%;
			}

			.smaller {
				font-size: 50%;
			}

			.double {
				display: flex;
				flex-direction: row;
				justify-content: space-evenly;
			}

			.holder {
				border: 1px solid rgb(53, 53, 53);
				border-radius: 20px;
				background-color: rgba(255, 255, 255, 0.935);
				padding: 60px 30px;
			}

			.quote {
				border: 1px solid black;
				border-radius: 20px;
				background-color: white;
				margin: 10px 0;
				padding: 30px;
			}

			li.top {
				font-size: 160%;
				font-weight: bolder;
				margin-bottom: 30px;
				list-style-type: none;
			}

			.reveal .slides b {
				font-size: 110%;
				font-weight: 900;
			}

			.reveal .slides i {
				font-style: italic;
			}

			.reveal .slides li:not(:first-child) {
				margin-top: 5px;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<div class="mytitle">Michael Henretty</div>
					<sub>Coding Case Study</sub>
				</section>
				<section>
					<ul>
						<li class="top">About Me</li>
						<li>Lead full-stack engineer at Dropbox</li>
						<li>Started Common Voice project at Mozilla</li>
						<li>Contributed to WHATWG Web Notification Spec</li>
						<li>Amateur video game developer</li>
					</ul>
				</section>
				<section>
					<div class="normal">
						<div class="heading">Prompt</div>
						<div class="quote">
							"...to present<br />
							<br />
							the business challenge/ask,<br />
							what you worked on,<br />
							how you + the team accomplished your goals,<br />
							<br />
							all while focusing on the FS/UI components..."
						</div>
					</div>
				</section>
				<section data-background-image="static/engineer-brain.png" data-background-opacity="0.5" data-transition="zoom-in slide-out">
					<div class="holder">
						<ul>
							<li class="top">My Goals</li>
							<li><b>Communicate</b> my engineering principles</li>
							<li><b>Demonstrate</b> how I evaluate technologies</li>
							<li><b>Explain</b> my architectural approach</li>
							<li><b>Encourage </b> feedback/discussion</li>
						</ul>
					</div>
				</section>
				<section>
					<div class="normal">
						<div class="heading">Project: Icebreak</div>
						<p>
							<b>Inspiration:</b> Remote companies often use video chat “breakout”
							rooms with a “prompt” to encourage rapport building among physically disparate employees.
						</p>
					</div>
				</section>
				<section>
					<div class="normal">
						<div class="heading">Project: Icebreak</div>
						<p>
							<b>Problem:</b> It can be awkward to get started, or know when to talk.
							Also not everyone feels comfortable participating.
						</p>
					</div>
				</section>
				<section>
					<div class="normal">
						<div class="heading">Project: Icebreak</div>
						<p>
							<b>Idea:</b> <i>How might I create a simple web game to help facilitate these “ice-breakers?”</i>
						</p>
					</div>
				</section>
				<section data-background-image="static/friends.png" data-background-opacity="0.5" data-transition="zoom-in slide-out">
					<div class="holder">
						<ul>
							<li class="top">Game Aspirations</li>
							<li>Low friction to get started</li>
							<li>No required reading (ie. rules)</li>
							<li>Can be played in a few minutes</li>
							<li>Facilitates rather than replaces conversation</li>
						</ul>
					</div>
				</section>
				<section>
						<video controls onloadstart="this.playbackRate = 2.5">
							<source src="static/icebreak-demo.webm" type="video/webm" />
						</video>
				</section>
				<section>
					<ul>
						<li class="top">Foundation</li>
						<li><b>Environment:</b> Docker 20</li>
						<li style="margin-top: 20px"><b>Utilities:</b> Yarn 1.22, TypeScript 4.6, ESLint 8</li>
						<li style="margin-top: 20px"><b>Front-end:</b> React 18, Webpack 5</li>
						<li><b>Back-end:</b> Node v18, Express 4, Postgres 14</li>
					</ul>
				</section>
				<section>
					<div class="heading" style="text-align: center;">Let's Take A Deeper Look</div>
					<ol start="1">
						<li>Client synchronization</li>
						<li>Database management</li>
					</ol>
				</section>
				<section>
					<div class="mytitle">Client Sync</div>
				</section>
				<section data-transition="convex">
					<img style="display: inline-block; height:600px" src="static/react-arch.png" />
				</section>
				<section data-transition="convex">
					<img style="display: inline-block; height:600px" src="static/Icebreak-arch.png" />
				</section>
				<section data-transition="concave-in slide-out">
					<ul>
						<li class="top">Why Server-sent Events?</li>
						<li>Lightweight and simple <span class="small">(uses HTTP)</span></li>
						<li>No additional configuration <span class="small">(à la websockets)</span></li>
						<li>No session signaling <span class="small">(à la WebRTC)</span></li>
						<li>Full browser support <span class="small">(except IE 11)</span></li>
						<li>Don't need full duplex <span class="small">(push is enough)</span></li>
					</ul>
				</section>
				<section data-transition="convex">
					<div class="heading">Front-end</div>
					<pre class="typescript">
						<code data-line-numbers="1-6|8-11|16|18|22-23|32|36-39|41-47|48-53">
							<script type="text/template">// Ex. hooks.ts
type HookResult<T> = [
	boolean,          // isLoading
	string | null,    // errorMessage
	T | null          // apiResponse
];

function useRoomData(roomId: string): HookResult<Room> {
	const [loading, setLoading] = useState<boolean>(true);
	const [error, setError] = useState<string | null>(null);
	const [roomData, setRoomData] = useState<RoomResult | null>(null);
	
	React.useEffect(() => {
		setIsLoading(true);

		const sse = new EventSource(`/join/${roomId}`);

		sse.addEventListener('update', (evt: MessageEvent) => {
			setError(null);
			setIsLoading(false);
			try {
				const result = JSON.parse(evt.data);
				setRoomData(result);
			} catch (e) {
				setError('Unable to process room update');
			}
		});
	
		return cleanUpEvtSource();
	});

	return [loading, error, roomData];
}


// Room.tsx
const Room = ({ user, roomId }: RoomProps) => {
  const [loading, error, roomData] = useRoomData(roomId);

	return (
    <div className='roomContainer'>
      {error && (
				<div className='error'><span>{error}</span></div>
			)}
      {loading && (
				<div className='loadingSpinner'></div>
			)}
      {roomData && user.isHost && (
        <HostRoom roomData={roomData} />
      )}
      {roomData && !user.isHost && (
        <PlayerRoom roomData={roomData} user={user} />
      )}
    </div>
	);

							</script>
						</code>
					</pre>
				</section>
				<section data-transition="convex">
					<div class="heading">Back-end</div>
					<pre class="typescript">
						<code data-line-numbers="1-6|9-20|23-32">
							<script type="text/template">// Ex. server.ts
type Clients = Map<ClientId, ExpressResponse>;
type Rooms = Map<RoomId, Clients>;

const rooms: Rooms = new Map();
const app = express();


// Middleware handler for joining a room.
app.get('/join/:roomId', (req, res) => {
	const {roomId, clientId} = getParams(req);

	let room = rooms.get(roomId);
  if (!room) {
    room = new Map();
    rooms.set(roomId, room);
  }

  room.set(clientId, res);
});


// Called every time we update Room data.
function sendRoomUpdate(room: RoomEntity) {
	const clients = rooms.get(room.id);

	// Send room data to every client in room.
	for (let [clientId, res] of clients) {
		const roomData = getSSERoomData(room, clientId);
		res.write(roomData);
	}
}

						</script>
					</code>
				</pre>
				</section>
				<section data-transition="convex">
					<img style="display: inline-block; height:600px" src="static/Icebreak-arch.png" />
				</section>
				<section>
					<div class="mytitle">Database Management</div>
				</section>
				<section style>
					<div class="double">
						<ul>
							<li class="top">DB Problems</li>
							<li><b>Schemas</b> are entropic</li>
							<li><b>Migrations</b> are tricky</li>
							<li><b>Security</b> is critical</li>
							<li><b>DBA</b> is a full-time job</li>
						</ul>
						<img style="border-radius: 10px; display: inline-block; width:40%; margin-left: 80px" src="static/Icebreak-schema.png" />
					</div>
				</section>
				<section>
					<div class="heading" style="text-align: center;">Are ORMs the solution?</div>
					<div class="double">
						<ul>
							<li class="top" style="font-size: 120%; margin-bottom: 15px; color: rgb(0, 192, 0)">Pros</li>
							<li>OOP for CRUD</li>
							<li>Security built-in</li>
							<li>Feature rich:
							<li style="font-size: 50%; list-style: none;">prepared statements, connection pooling, transactions, etc.</li>
						</ul>
						<ul>
							<li class="top" style="font-size: 120%; margin-bottom: 15px; color: rgb(228, 52, 52)">Cons</li>
							<li><b>Performance!</b></li>
							<li>Entities and Schema syncing</li>
							<li>How to do complex queries?</li>
						</ul>
					</div>
				</section>
				<section data-background-image="static/thinking.png" data-background-opacity="0.5" data-transition="zoom">
					<div class="holder">
						<ul>
							<li class="top">What I Want</li>
							<li>Typed Entities</li>
							<li>No writing migration scripts by hand</li>
							<li>No manual syncing entities with schema</li>
						</ul>
					</div>
				</section>
				<section data-background-image="static/thinking.png" data-background-opacity="0.5" data-transition="zoom-in slide-out">
					<div class="holder" style="text-align: left">
						<b>I want to only define schema, <br />
							let ORM manage Entities, DB, migrations
						</b>
					</div>
				</section>
				<section>
					<ul>
						<li class="top">Top JavaScript ORMs</li>
						<li>Sequelize (2010) - 5 million monthly downloads</li>
						<ul class="smaller">
							<li>TypeScript support still WIP</li>
							<li>Have to manually write migrations</li>
						</ul>
						<li>Knex.js (2012) - 5 million monthly downloads</li>
						<ul class="smaller">
							<li>“TypeScript support is currently best-effort”</li>
							<li>Have to manually write migrations</li>
						</ul>
						<li>Prisma (2019) - 2 million monthly downloads</li>
						<ul class="smaller">
							<li>Uses DSL to define Schema</li>
							<li>Can auto-generate both migrations and entities</li>
							<li>PAAS model, some features behind paywall</li>
						</ul>
						<li><b>TypeORM (2016) - 4 million monthly</b></li>
						<ul class="smaller">
							<li><i>Entities are schema using decorators</i></li>
							<li>Auto-generate migrations</li>
							<li>Still in beta after 6 years</li>
						</ul>
					</ul>
				</section>
				<section data-transition="concave-in slide-out">
					<video controls onloadstart="this.playbackRate = 1.3">
						<source src="static/migrations.webm" type="video/webm" />
					</video>
				</section>
				<section data-background-image="static/boxes.png" data-background-opacity="0.5" data-transition="zoom-in slide-out">
					<div class="holder">
						<ul>
							<li class="top">My Principles</li>
							<li>Keep it simple</li>
							<li>Embrace the types</li>
							<li>Fast developer loop</li>
						</ul>
					</div>
				</section>
				<section>
					<div class="mytitle">QUESTIONS?</div>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				controls: false,
				slideNumber: 'c/t',
				hashOneBasedIndex: true,
				transition: 'concave',

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
